---
title: "ICP Data Processing (full version)"
author: "CGA"
date: "May 22, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(reshape2)
library(ggplot2)
library(dplyr)
setwd("~/R/R_ICP_processing/") #set the working directory
```

# A few notes:
* use DBN for analysis condition
* looking at Al27, Si28, Fe56
* first 10 qc's measured as "UNK" are blanks (in the raw file from Mariela)
* second 10 qc's measured as "UNK" are at 750ppb (in the raw file from Mariela)
* treat blanks and control1's as samples (keep them in the sample data sheet)
* append the calibration curves for each element at the beginning of the data sheet

## 1. Read in raw ICP data
```{r}
#icp.decoder <- read_excel("Mariela_sample.key.xlsx")
icp <- read_excel("Mariela050117_rawdata_water.xlsx") #input your datafile
icp <- subset(icp, Mass %in% c(27,28,56)) #subsetting only Al27, Si28, Fe56

icp.dbn <- subset(icp, `Analysis Condition` %in% "DBN")
```

## 2. Manipulate ICP data
```{r}
#Remove extraneous columns
keeps <- c("Sample Name","Element", "Class", #could also keep "Mass"
           #"Conc.[1]","Conc.[2]","Conc.[3]",
           "Conc.[Ave.]","Conc.[SD]","Conc.[RSD]",
           #"Intensity[1]","Intensity[2]","Intensity[3]",
           "Intensity[Ave.]","Intensity[SD]","Intensity[RSD]")
icp.dbn.subset <- icp.dbn[, names(icp.dbn) %in% keeps]

#Subset the samples and calibration standards
icp_samp <- subset(icp.dbn.subset, Class %in% "UNK")
icp_cal <- subset(icp.dbn.subset, !(Class %in% "UNK"))

#Set the Al, Fe, and Si blanks
al_blank <- icp_samp$`Conc.[Ave.]`[icp_samp$Element=="Al"][1]
fe_blank <- icp_samp$`Conc.[Ave.]`[icp_samp$Element=="Fe"][1]
si_blank <- icp_samp$`Conc.[Ave.]`[icp_samp$Element=="Si"][1]

#Add a column for blank-corrected concentration
#icp_samp$Conc_Blank.Corr <- icp_samp$`Conc.[Ave.]` - 
#  ifelse(icp_samp$Element=="Al", al_blank,
#         ifelse(icp_samp$Element=="Fe", fe_blank, si_blank))

#Merge with sample decoder (from Mariela's processed data sheet)
#icp_merge <- join(icp_samp, icp.decoder, by="Sample.Name", match="all") #use "join" (package plyr) to keep row order

#Using "grep", remove blanks and QCs from the dataframe
#icp_merge_samples <- icp_merge[!grepl("QC", icp_merge$Sample.Name, ignore.case=TRUE),]
#icp_merge_samples <- icp_merge_samples[!grepl("Blank", icp_merge_samples$Sample.Name, ignore.case=TRUE),]

#Sort by Element/Mass
icp_samp <- icp_samp[with(icp_samp, order(Element)), ]

#Combine Element and Mass into one column, then delete Element and Mass Columns?
#icp_samp$Element_Mass <- paste(icp_samp$Element, icp_samp$Mass, sep="_")

#Run dcast to convert from long to wide data (see e.g. http://seananderson.ca/2013/10/19/reshape.html)
#ID's = "Sample Name"
#variable = "Element", "Class"
icp_samp <- subset(icp_samp, select = -c(Class))

#Add unique ID for all samples (there are reps in QC/blanks so you otherwise can't cast the dataframe)
#icp_samp$Group <- 1:nrow(icp_samp) 

#Subset into the three elements (Al, Fe, Si)
icp_al <- subset(icp_samp, Element %in% "Al")
icp_fe <- subset(icp_samp, Element %in% "Fe")
icp_si <- subset(icp_samp, Element %in% "Si")

#Add prefixes to column names, based on element, delete Element column
colnames(icp_al)[c(3:8)] <- paste("Al", colnames(icp_al)[c(3:8)], sep = "_")
icp_al <- subset(icp_al, select = -c(Element))

colnames(icp_fe)[c(3:8)] <- paste("Fe", colnames(icp_fe)[c(3:8)], sep = "_")
icp_fe <- subset(icp_fe, select = -c(Element))

colnames(icp_si)[c(3:8)] <- paste("Si", colnames(icp_si)[c(3:8)], sep = "_")
icp_si <- subset(icp_si, select = -c(Element))

#Merge the three elements back into one dataframe
icp_total <- merge(icp_al, icp_fe)
icp_total <- merge(icp_total, icp_si)

#Write to new csv file
write.csv(icp_samp, file="23May2017_ICP_testformat.csv")

```

## 3. Calibration curves (compare manual curves with ICP-generated curves)
```{r}
#For now we'll just use the ICP-generated calibration curves

#Remove extraneous columns
drops <- c("Conc.[Ave.]","Conc.[SD]","Conc.[RSD]","Analysis Condition")
icp_cal <- icp_cal[, !(names(icp_cal) %in% drops)]

#Sort by Element/Mass
icp_cal <- icp_cal[with(icp_cal, order(Element)), ]

```


## 4. Exploratory plots
```{r}
#Histogram of concentrations for Al, Fe, Si
ggplot(icp_samp, aes(x=`Conc.[Ave.]`)) +
  geom_histogram() +
  facet_wrap(~Element, scales="free")

#Boxplot of Al, Fe, Si concentrations in the different splits
ggplot(icp_merge_samples, aes(x=Split, y=Conc_Blank.Corr)) +
  geom_boxplot() +
  facet_wrap(~Element, scales="free")
```